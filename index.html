<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Gebedstijden - Den Haag</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Arap√ßa hat fontu -->
  <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Segoe UI", system-ui, Arial, sans-serif;
      background: radial-gradient(circle at top, #141b3a 0%, #040614 55%, #02030a 100%);
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      overflow-x: hidden;
    }

    .container {
      width: 100%;
      max-width: 1400px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    /* Bismillah */
    .bismillah {
      margin-top: 8px;
      text-align: center;
      font-family: "Amiri Quran", serif;
      font-size: 2.9rem;
      color: #21e6b8;
      font-weight: 400;
      letter-spacing: 1px;
      text-shadow:
        0 0 6px rgba(33,230,184,0.9),
        0 0 14px rgba(33,230,184,0.7),
        0 0 30px rgba(0,0,0,0.8);
    }

    /* Top bar */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .topbar-left { display: flex; align-items: center; gap: 10px; }
    .top-dot {
      width: 10px; height: 10px;
      border-radius: 999px;
      background: #21e6b8;
      box-shadow: 0 0 10px #21e6b8;
    }
    .top-title {
      font-size: 0.95rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      opacity: 0.8;
    }
    .top-right { font-size: 0.85rem; opacity: 0.7; }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      flex-wrap: wrap;
      gap: 12px;
    }
    .location {
      font-size: 2.3rem;
      font-weight: 700;
      letter-spacing: 2px;
    }
    .date { opacity: 0.85; font-size: 1rem; margin-top: 4px; }

    /* ‚úÖ SAAT B√úY√úT√úLD√ú */
    .clock {
      font-size: clamp(5.2rem, 7.2vw, 8.2rem);
      font-weight: 800;
      letter-spacing: 2px;
      text-align: right;
    }
    .tz-label { text-align: right; font-size: 0.9rem; opacity: 0.65; }

    /* Layout */
    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.1fr);
      gap: 22px;
    }
    @media (max-width: 900px) {
      .main-layout { grid-template-columns: 1fr; }
    }

    .left-column { display: flex; flex-direction: column; gap: 18px; }

    /* Next panel */
    .next-panel {
      flex: 1;
      background: linear-gradient(135deg, rgba(33,230,184,0.12), rgba(5,8,30,0.95));
      padding: 22px;
      border-radius: 20px;
      border: 1px solid rgba(33,230,184,0.30);
      box-shadow: 0 0 24px rgba(0,0,0,0.45);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 18px;
    }
    .next-label { opacity: 0.8; font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase; }
    .next-name { font-size: 2rem; font-weight: 700; margin-top: 4px; }
    .next-time { font-size: 1.6rem; opacity: 0.9; }
    .next-countdown { font-size: 1.2rem; opacity: 0.9; }

    .btn {
      padding: 12px 22px;
      border-radius: 999px;
      background: #21e6b8;
      color: #000;
      font-weight: 700;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      transition: 0.2s;
    }
    .btn:hover { background: #39ffd0; }

    /* Grid */
    .grid-panel {
      background: rgba(255,255,255,0.03);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 0 18px rgba(0,0,0,0.4);
    }
    .grid-title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      opacity: 0.8;
      margin-bottom: 14px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 14px;
    }
    @media (max-width: 700px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
    }

    .card {
      background: radial-gradient(circle at top, rgba(255,255,255,0.10), rgba(2,3,12,0.95));
      padding: 18px;
      border-radius: 16px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.06);
      transition: 0.25s ease;
      position: relative;
    }

    .card-name {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      opacity: 0.85;
      margin-bottom: 8px;
    }

    .card-time {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .card-extra {
      font-size: 0.8rem;
      opacity: 0.75;
      margin-top: 4px;
    }

    .card.highlight {
      border-color: #21e6b8;
      box-shadow: 0 0 20px rgba(33,230,184,0.75);
      transform: translateY(-3px) scale(1.03);
    }

    /* Logo */
    .logo-box {
      margin-top: 32px;
      display: flex;
      justify-content: center;
      opacity: 0.8;
    }
    .logo-box img {
      height: 130px;
      object-fit: contain;
      filter: drop-shadow(0 0 6px rgba(0,0,0,0.5));
    }
  </style>
</head>

<body>
<div class="container">

  <!-- Bismillah -->
  <div class="bismillah">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸëŸéŸáŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê</div>

  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-left">
      <div class="top-dot"></div>
      <div class="top-title">Gebedstijden Paneel</div>
    </div>
    <div class="top-right">AbanGroup ‚Ä¢ Den Haag</div>
  </div>

  <!-- Header -->
  <header class="header">
    <div>
      <div class="location">Den Haag</div>
      <div class="date" id="dateDisplay"></div>
    </div>
    <div>
      <div class="clock" id="clock">--:--:--</div>
      <div class="tz-label">Europe/Amsterdam</div>
    </div>
  </header>

  <!-- Main layout -->
  <section class="main-layout">

    <!-- Left -->
    <div class="left-column">
      <div class="next-panel">
        <div>
          <div class="next-label">Volgende gebed</div>
          <div class="next-name" id="nextPrayerName">-</div>
          <div class="next-time" id="nextPrayerTime">-</div>
        </div>
        <div class="next-countdown" id="nextPrayerCountdown">-</div>
      </div>

      <button class="btn" id="playTestBtn">Ezan test / geluid inschakelen</button>
    </div>

    <!-- Right -->
    <div class="grid-panel">
      <div class="grid-title">Gebedstijden vandaag</div>
      <div class="grid" id="prayerGrid"></div>
    </div>

  </section>

  <!-- Logo -->
  <div class="logo-box">
    <img src="abanlogo.png" alt="Aban Group">
  </div>

</div>

<!-- Ezan ses dosyasƒ± -->
<audio id="adhanAudio" preload="auto">
  <source src="azan.mp3" type="audio/mpeg">
</audio>

<script>
/* ===========================
   KONFƒ∞G
=========================== */
const CITY     = "Den Haag";
const COUNTRY  = "Netherlands";
const METHOD   = 13;

const prayerOrder  = ["Fajr","Dhuhr","Asr","Maghrib","Isha"];
const displayOrder = ["Fajr","Sunrise","Dhuhr","Asr","Maghrib","Isha"];

const namesNL = {
  Fajr:    "Fajr / ƒ∞msak",
  Sunrise: "Shams / G√ºne≈ü",
  Dhuhr:   "Dhuhr / √ñƒüle",
  Asr:     "Asr / ƒ∞kindi",
  Maghrib: "Maghrib / Ak≈üam",
  Isha:    "Isha / Yatsƒ±"
};

let timings      = {};
let played       = {};
let scheduleDate = null;
let adhanEnabled = false;
let isFetching   = false;

/* ‚úÖ Yeni: Date objeleri ve gecikme toleransƒ± */
let prayerTimes  = {};     // {Fajr: Date, ...}
let lastCheckTs  = null;   // ms timestamp

/* ‚úÖ Wake Lock */
let wakeLock = null;

/* ===========================
   SAAT & TARƒ∞H
=========================== */
function updateClockAndDate() {
  const now = new Date();
  document.getElementById("clock").textContent =
    now.toLocaleTimeString("nl-NL",{hour12:false});

  const d = scheduleDate || now;
  document.getElementById("dateDisplay").textContent =
    d.toLocaleDateString("nl-NL",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
}
setInterval(updateClockAndDate, 1000);

/* ===========================
   API URL
=========================== */
function buildApiUrl(date){
  const d  = date || new Date();
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  const base = `https://api.aladhan.com/v1/timingsByCity/${dd}-${mm}-${yy}?city=${CITY}&country=${COUNTRY}&method=${METHOD}`;
  return "https://corsproxy.io/?" + encodeURIComponent(base);
}

/* ===========================
   VAKƒ∞TLERƒ∞ √áEK
=========================== */
function fetchTimes(date){
  if (isFetching) return;
  isFetching = true;

  scheduleDate = date || new Date();

  fetch(buildApiUrl(scheduleDate))
    .then(r => r.json())
    .then(j => {
      timings = j.data.timings;
      played  = {};

      /* ‚úÖ prayerTimes √ºret */
      prayerTimes = {};
      prayerOrder.forEach(k => {
        const raw = timings[k];
        if (!raw) return;
        const t = raw.split(" ")[0];
        if (!t.includes(":")) return;
        const [h, m] = t.split(":").map(Number);
        prayerTimes[k] = new Date(
          scheduleDate.getFullYear(),
          scheduleDate.getMonth(),
          scheduleDate.getDate(),
          h, m, 0, 0
        );
      });

      /* ‚úÖ gecikmeli interval ka√ßƒ±rmasƒ±n */
      lastCheckTs = Date.now();

      buildGrid();
      updateUI();
    })
    .catch(e => console.error("API error:", e))
    .finally(() => { isFetching = false; });
}

/* ===========================
   GRID
=========================== */
function buildGrid(){
  const grid = document.getElementById("prayerGrid");
  grid.innerHTML = "";

  if (!timings) return;

  displayOrder.forEach(k=>{
    const raw = timings[k];
    if (!raw) return;

    const t = raw.split(" ")[0];

    const card = document.createElement("div");
    card.className = "card";
    card.dataset.key = k;

    let extra = "";
    if (k === "Sunrise") extra = "G√ºne≈ü doƒüu≈üu";

    card.innerHTML = `
      <div class="card-name">${namesNL[k]}</div>
      <div class="card-time">${t}</div>
      <div class="card-extra">${extra}</div>
    `;
    grid.appendChild(card);
  });
}

/* ===========================
   SONRAKƒ∞ NAMAZ
=========================== */
function getNextPrayer(){
  if (!timings || !timings.Fajr || !scheduleDate) return null;

  const now = new Date();
  const d   = scheduleDate;
  let next  = null;

  prayerOrder.forEach(k=>{
    const raw = timings[k];
    if (!raw) return;

    const timeStr = raw.split(" ")[0];
    if (!timeStr.includes(":")) return;
    const [h,m] = timeStr.split(":").map(Number);

    const t = new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m);

    if (t > now && (!next || t < next.time)){
      next = { name: k, time: t };
    }
  });

  return next;
}

function formatDiff(ms){
  if (ms <= 0) return "Nu";
  const s = Math.floor(ms/1000);
  const m = Math.floor(s/60);
  const h = Math.floor(m/60);
  if (h > 0) return `${h} uur ${m%60} min`;
  return `${m} min ${s%60} sec`;
}

function updateUI(){
  if (!timings || !timings.Fajr || !scheduleDate) return;

  const next = getNextPrayer();
  const nameEl = document.getElementById("nextPrayerName");
  const timeEl = document.getElementById("nextPrayerTime");
  const cdEl   = document.getElementById("nextPrayerCountdown");

  if (!next){
    nameEl.textContent = "Alle gebeden voorbij";
    timeEl.textContent = "";
    cdEl.textContent   = "Nieuwe tijden worden geladen...";
    document.querySelectorAll(".card").forEach(c=>c.classList.remove("highlight"));
    return;
  }

  nameEl.textContent = namesNL[next.name];
  timeEl.textContent =
    next.time.toLocaleTimeString("nl-NL",{hour:"2-digit",minute:"2-digit",hour12:false});

  cdEl.textContent = formatDiff(next.time - new Date());

  document.querySelectorAll(".card").forEach(c=>c.classList.remove("highlight"));
  const active = document.querySelector(`.card[data-key="${next.name}"]`);
  if (active) active.classList.add("highlight");
}

/* ===========================
   G√úN √áEVƒ∞RME (ISHA SONRASI + TARƒ∞H DEƒûƒ∞≈ûƒ∞NCE)
=========================== */
function checkDayRollover(){
  if (!scheduleDate || !timings || !timings.Isha) return;

  const now = new Date();

  // ‚úÖ Takvim g√ºn√º deƒüi≈ütiyse direkt yeni g√ºn
  if (now.toDateString() !== scheduleDate.toDateString()) {
    fetchTimes(now);
    return;
  }

  const d = scheduleDate;
  const raw = timings.Isha.split(" ")[0];
  if (!raw.includes(":")) return;
  const [h,m] = raw.split(":").map(Number);

  const ishaTime = new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m);

  if (now > ishaTime) {
    const tomorrow = new Date(d.getTime() + 24*3600*1000);
    fetchTimes(tomorrow);
  }
}

/* ===========================
   EZAN √áALMA
=========================== */
function playAdhan(){
  const audio = document.getElementById("adhanAudio");
  audio.currentTime = 0;
  audio.play().catch(()=>{});
}

/* ‚úÖ Asƒ±l fix: ‚Äú1 dakikalƒ±k pencere‚Äù yerine ‚Äúson kontrol ‚Üí ≈üimdi aralƒ±ƒüƒ±nda ge√ßti mi?‚Äù */
function checkAdhanTrigger() {
  if (!adhanEnabled || !prayerTimes || !prayerTimes.Fajr) return;

  const now = Date.now();
  if (lastCheckTs == null) lastCheckTs = now;

  const from = lastCheckTs;
  const to   = now;

  prayerOrder.forEach(key => {
    const pt = prayerTimes[key];
    if (!pt) return;

    const t = pt.getTime();

    // from < t <= to aralƒ±ƒüƒ±nda vakit ge√ßtiyse √ßal (gecikmede ka√ßƒ±rmaz)
    if (!played[key] && t > from && t <= to) {
      played[key] = true;
      console.log("üîä EZAN √áALIYOR:", key, new Date(t).toLocaleTimeString("nl-NL",{hour12:false}));
      playAdhan();
    }
  });

  lastCheckTs = now;
}

/* ===========================
   WAKE LOCK (tablet donmalarƒ±nƒ± azaltƒ±r)
=========================== */
async function enableWakeLock() {
  try {
    if (!("wakeLock" in navigator)) return;
    wakeLock = await navigator.wakeLock.request("screen");
    console.log("‚úÖ Wake Lock aktif");
    wakeLock.addEventListener("release", () => console.log("‚ö†Ô∏è Wake Lock bƒ±rakƒ±ldƒ±"));
  } catch (e) {
    console.log("Wake Lock alƒ±namadƒ±:", e);
  }
}

document.addEventListener("visibilitychange", async () => {
  if (document.visibilityState === "visible" && adhanEnabled) {
    await enableWakeLock();
    updateUI();
  }
});

/* ===========================
   BUTON
=========================== */
document.getElementById("playTestBtn").addEventListener("click", async ()=>{
  adhanEnabled = true;
  await enableWakeLock();
  playAdhan();  // test
});

/* ===========================
   LOOP & START
=========================== */
setInterval(updateUI, 1000);
setInterval(checkAdhanTrigger, 1000);
setInterval(checkDayRollover, 5000);

fetchTimes(new Date());
</script>

</body>
</html>

